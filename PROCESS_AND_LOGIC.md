# 薪資轉帳自動化系統 - 處理思路和邏輯記錄

## 📌 任務目標
**用户需求**: 根據 CSV 檔案資料自動輸入到富邦銀行薪資轉帳系統，並生成可上傳的 txt 檔案。

---

## 🧠 思路分析過程

### 第一步：理解用户需求
- ✅ 用户有一份 CSV 檔案包含員工薪資資料
- ✅ 需要委託單位代號（7 碼）用於生成檔案
- ✅ 需要生成 txt 檔案用於上傳到富邦系統
- ✅ 目標是自動化整個過程，節省手動輸入時間

### 第二步：探索現有系統
讀取並分析了：
1. **index.html** - Vue.js 前端界面，包含表單和驗證邏輯
2. **populate_data.js** - 瀏覽器控制台腳本，用來自動填充表單
3. **USAGE_GUIDE.md** 和其他文檔

**發現的關鍵信息**:
- 系統使用 Vue 3 框架
- 有現成的表單驗證邏輯
- 已有瀏覽器端的自動填充腳本
- txt 檔案格式有特定要求（K 行 + C 行）

### 第三步：策略決定
**決定**: 不在瀏覽器中操作，而是創建 Node.js 腳本來直接生成 txt 檔案

**原因**:
1. 用户需要自動化流程，不想手動操作瀏覽器
2. 創建 Node.js 腳本可以一鍵執行，更加高效
3. 可以複用表單驗證邏輯中的 txt 生成算法

### 第四步：技術實現規劃
```
CSV 檔案 → 解析 CSV → 提取員工資料 → 驗證資料 → 按規定格式組合 → 生成 txt 檔案 → 儲存到桌面
```

### 第五步：遇到的問題及解決方案

#### 問題 1: 使用外部模組失敗
```javascript
// 嘗試使用 csv-parse 模組
const csv = require('csv-parse/lib/sync');
// ❌ 結果: 模組未安裝
```

**解決方案**: 自己寫簡單的 CSV 解析函數
```javascript
function parseCSV(csvData) {
  // 手動處理逗號分隔和引號處理
  // 這樣不依賴外部模組
}
```

#### 問題 2: CSV 欄位映射
CSV 檔案有 9 個欄位，需要確定哪些是必需的

**解決方案**: 根據原始 HTML 表單欄位映射：
- 帳號 → `accountNumber`（必需）
- 應付薪資 → `salary`（必需）
- 身份證號 → `idNumber`（必需）
- 姓名 → 用於日誌和備註

---

## 🔑 核心邏輯詳解

### txt 檔案格式規則
根據 index.html 的 `submitForm` 函數（第 374-447 行）:

#### 第一行（K 行 - 批次檔頭）
```
K + 委託單位代號(7碼) + 00000 + *(12碼) + 發薪日期(7碼) + 薪資總額(13碼)
```

例如：
```
K123456700000************11412100000068000000
```

**說明**:
- `K` - 固定前綴
- `1234567` - 委託單位代號
- `00000` - 固定填充
- `************` - 12 個星號（固定）
- `1141210` - 民國年(114) + 月(12) + 日(10)
- `0000068000000` - 薪資總額 × 100，左邊補 0 到 13 碼

#### 每位員工一行（C 行）
```
C + 委託單位代號(7碼) + 00000 + 帳號(14碼) + 000000 + 薪資(13碼) + 身份證號(10碼)
```

例如：
```
C123456700000001234567890120000000000003400000A123456789
```

**說明**:
- `C` - 固定前綴
- `1234567` - 委託單位代號
- `00000` - 固定填充
- `00012345678901` - 帳號只保留數字，左邊補 0 到 14 碼
- `000000` - 固定填充
- `0000003400000` - 薪資 × 100，左邊補 0 到 13 碼
- `A123456789  ` - 身份證號大寫，右邊補空白到 10 碼

### 日期計算
```javascript
const rocYear = today.getFullYear() - 1911;  // 西元轉民國
const month = String(month).padStart(2, '0');  // 補零到 2 碼
const day = String(day).padStart(2, '0');      // 補零到 2 碼
```

例如: 2025-12-10 → 114-12-10

### 薪資計算
```javascript
// 所有員工薪資相加
const totalSalary = employees.reduce((sum, emp) => sum + emp.salary, 0);

// 乘以 100（因為銀行系統用分位單位）然後左邊補 0 到 13 碼
const totalSalaryStr = String(Math.round(totalSalary * 100)).padStart(13, '0');
```

### CSV 解析邏輯
```javascript
// 1. 讀取第一行作為標題
// 2. 從第二行開始讀取資料
// 3. 處理逗號分隔和引號（某些欄位可能包含逗號）
// 4. 過濾掉 NO 欄位是 "合計" 的行
// 5. 轉換為員工物件陣列
```

---

## 📊 資料轉換流程

### 輸入 (CSV)
```
NO: 1
姓名: 王小明
應付薪資: 34,000
身分證號: A123456789
帳號: 1234-5678-9012
```

### 中間轉換
```javascript
{
  name: '王小明',
  salary: 34000,        // 移除逗號，轉為數字
  idNumber: 'A123456789',
  accountNumber: '1234-5678-9012'
}
```

### 輸出 (txt)
```
C123456700000001234567890120000000000003400000A123456789
 ↑
 帳號 '1234-5678-9012' → 移除非數字 → '12345678901' → 左補 0 到 14 碼 → '00012345678901'
 薪資 34000 → × 100 → 3400000 → 左補 0 到 13 碼 → '0000003400000'
 身份證 'A123456789' → 大寫 + 右補空白到 10 碼 → 'A123456789  '
```

---

## 🚀 執行流程圖

```
開始
  ↓
讀取 CSV 檔案
  ↓
解析 CSV 內容（逐行處理）
  ↓
過濾有效的員工記錄（排除合計行、空行）
  ↓
驗證必要欄位是否存在
  ↓
計算發薪日期（西元轉民國）
  ↓
計算薪資總額
  ↓
生成第一行（K 行）
  ↓
迴圈每位員工，生成 C 行
  ↓
組合所有內容
  ↓
寫入 txt 檔案
  ↓
輸出執行結果
  ↓
完成
```

---

## 💾 檔案結構

```
/Users/stephenlee-sheng/Desktop/Projects/CS/fubon.html/
├── index.html                      # 前端界面
├── populate_data.js                # 瀏覽器端自動填充腳本
├── generate_salary_file.js         # ✅ 新建 Node.js 腳本（核心）
├── USAGE_GUIDE.md                  # ✅ 新建 使用說明
├── PROCESS_AND_LOGIC.md            # ✅ 新建 本文件（思路記錄）
└── HOW_TO_USE_POPULATE_SCRIPT.md   # 舊文件（瀏覽器方式）
```

---

## 🔄 下次使用時的檢查清單

當用户提出類似需求時，按以下步驟：

- [ ] **確認目標**: CSV 轉換為富邦 txt 檔案？
- [ ] **獲取參數**:
  - CSV 檔案位置
  - 委託單位代號（7 碼）
  - 發薪日期（如不提供，使用當天日期）
- [ ] **驗證 CSV 格式**:
  - 檢查 NO、姓名、應付薪資、身分證號、帳號欄位
  - 確認是否有 "合計" 行（需要排除）
- [ ] **執行腳本**:
  ```bash
  node generate_salary_file.js --code 你的委託單位代號
  ```
- [ ] **驗證結果**:
  - 員工數是否正確
  - 薪資總額是否正確
  - 檔案是否成功生成
- [ ] **回報用户**:
  - 檔案位置
  - 員工統計
  - 薪資總額

---

## ⚙️ 可能的改進方向

1. **參數化**: 將委託單位代號和 CSV 路徑作為命令列參數
   ```bash
   node generate_salary_file.js --csv path/to/file.csv --code 6711898
   ```

2. **錯誤處理**: 更詳細的錯誤提示
   - 檔案不存在
   - 必要欄位缺失
   - 資料格式錯誤

3. **日期設定**: 允許用户指定發薪日期
   ```bash
   node generate_salary_file.js --date 1141201
   ```

4. **驗證功能**: 生成報告檢查是否有異常
   - 薪資是否合理
   - 身份證號格式是否正確
   - 帳號是否有效

5. **Web 界面**: 保留原有 HTML 界面，但自動從 CSV 預填

---

## 📝 版本歷史

| 版本 | 日期 | 說明 |
|------|------|------|
| 1.0 | 2025-12-10 | 初版，支援 CSV 轉 txt，自動計算日期和薪資 |

---

## 🎯 總結

**核心思想**: 不操作瀏覽器，而是用 Node.js 腳本直接從 CSV 生成富邦要求的 txt 格式。

**關鍵點**:
1. CSV 必須包含: 應付薪資、身分證號、帳號
2. txt 格式有兩種行: K 行（批次頭）+ C 行（員工記錄）
3. 所有薪資金額需要乘以 100（分位單位）
4. 帳號只保留數字，身份證號需要大寫
5. 使用民國年份（西元-1911）

**一鍵執行**:
```bash
node generate_salary_file.js --code 你的委託單位代號
```

完成！🎉
